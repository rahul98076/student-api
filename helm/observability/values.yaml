kube-prometheus-stack:
  prometheus:
    prometheusSpec:
      nodeSelector:
        type: dependent_services
      serviceMonitorSelectorNilUsesHelmValues: false
      serviceMonitorSelector: {}
      serviceMonitorNamespaceSelector: {}
      podMonitorSelectorNilUsesHelmValues: false
      podMonitorSelector: {}
      podMonitorNamespaceSelector: {}
      ruleSelectorNilUsesHelmValues: false
      ruleSelector: {}
      ruleNamespaceSelector: {}
  alertmanager:
    alertmanagerSpec:
      nodeSelector:
        type: dependent_services
    config:
      global:
        resolve_timeout: 5m
      route:
        receiver: slack-notifications
        group_by: ["alertname", "namespace"]
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 1h
      receivers:
        - name: slack-notifications
          slack_configs:
            - api_url: "https://hooks.slack.com/services/CHANGE/ME"
              channel: "#alerts"
              send_resolved: true
              title: "{{ .CommonAnnotations.summary }}"
              text: "{{ .CommonAnnotations.description }}"
  grafana:
    adminPassword: "admin"
    nodeSelector:
      type: dependent_services
    sidecar:
      datasources:
        enabled: true
        defaultDatasourceEnabled: false
      dashboards:
        enabled: true
        label: grafana_dashboard
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            access: proxy
            url: http://observability-kube-prometh-prometheus:9090
            isDefault: true
          - name: Loki
            type: loki
            access: proxy
            url: http://observability-loki:3100
  kube-state-metrics:
    nodeSelector:
      type: dependent_services
  prometheusOperator:
    nodeSelector:
      type: dependent_services

loki:
  nodeSelector:
    type: dependent_services
  deploymentMode: SingleBinary
  loki:
    useTestSchema: true
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    storage:
      type: filesystem
      bucketNames:
        chunks: loki-chunks
        ruler: loki-ruler
        admin: loki-admin
    rulerConfig:
      enable_api: false
      enable_sharding: false
      storage:
        type: local
        local:
          directory: /var/loki/rules-temp
  singleBinary:
    replicas: 1
    nodeSelector:
      type: dependent_services
    extraVolumes:
      - name: rules-temp
        emptyDir: {}
    extraVolumeMounts:
      - name: rules-temp
        mountPath: /var/loki/rules-temp
    podSecurityContext:
      fsGroup: 10001
      runAsUser: 10001
      runAsNonRoot: true
  chunksCache:
    enabled: false
  resultsCache:
    enabled: false
  gateway:
    enabled: false
  read:
    replicas: 0
  write:
    replicas: 0
  backend:
    replicas: 0
  test:
    enabled: false
  monitoring:
    dashboards:
      enabled: false
    rules:
      enabled: false
    serviceMonitor:
      enabled: false
    selfMonitoring:
      enabled: false
      grafanaAgent:
        installOperator: false
    lokiCanary:
      enabled: false

promtail:
  config:
    server:
      http_listen_port: 3101
      grpc_listen_port: 0
    positions:
      filename: /run/promtail/positions.yaml
    clients:
      - url: http://observability-loki:3100/loki/api/v1/push
    scrape_configs:
      - job_name: student-api
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: student-api
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: student-api
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_container_name]
            target_label: container

prometheus-postgres-exporter:
  nodeSelector:
    type: dependent_services
  config:
    datasource:
      host: postgres-postgresql.student-api.svc.cluster.local
      user: postgres
      password: password
      port: "5432"
      database: studentdb
  serviceMonitor:
    enabled: true
    interval: 30s
    labels:
      release: observability

prometheus-blackbox-exporter:
  nodeSelector:
    type: dependent_services
  serviceMonitor:
    enabled: true
    labels:
      release: observability
    targets:
      - name: student-api
        url: http://student-api.student-api.svc.cluster.local:8080/healthcheck
        interval: 30s
        scrapeTimeout: 10s
      - name: vault
        url: http://vault.vault.svc.cluster.local:8200/v1/sys/health
        interval: 30s
        scrapeTimeout: 10s
      - name: argocd
        url: http://argocd-server.argocd.svc.cluster.local/healthz
        interval: 30s
        scrapeTimeout: 10s
