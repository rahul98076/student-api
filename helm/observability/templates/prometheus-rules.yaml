apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ .Release.Name }}-alerts
  labels:
    release: {{ .Release.Name }}
spec:
  groups:
    - name: student-api-observability
      rules:
        - alert: NodeHighCpuUsage
          expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: High CPU usage on node
            description: CPU usage has been above 80% for more than 10 minutes.
        - alert: NodeHighDiskUsage
          expr: 100 - (node_filesystem_avail_bytes{mountpoint="/", fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{mountpoint="/", fstype!~"tmpfs|overlay"} * 100) > 85
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: High disk usage on node
            description: Disk usage has been above 85% for more than 10 minutes.
        - alert: EndpointDown
          expr: probe_success == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: Endpoint down
            description: Blackbox probe failed for one or more endpoints.
        - alert: EndpointLatencyP95
          expr: histogram_quantile(0.95, sum by (le, instance) (rate(probe_http_duration_seconds_bucket[5m]))) > 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: Endpoint latency high
            description: p95 latency for probes is above 1s.
        - alert: Http5xxDetected
          expr: probe_http_status_code >= 500
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: HTTP 5xx detected by probes
            description: Blackbox probe returned a 5xx response.
        - alert: ServiceRestarts
          expr: increase(kube_pod_container_status_restarts_total{namespace=~"argocd|vault|student-api"}[10m]) > 0
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: Service restart detected
            description: One or more core services restarted in the last 10 minutes.
        - alert: HighRequestRate
          expr: sum(rate(http_requests_total[5m])) > 50
          for: 10m
          labels:
            severity: info
          annotations:
            summary: High request rate
            description: Request rate exceeded 50 requests per second.
